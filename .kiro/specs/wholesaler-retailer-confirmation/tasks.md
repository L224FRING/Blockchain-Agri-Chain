# Implementation Plan

- [x] 1. Update SupplyChain.sol contract with retailer transfer proposal system
  - Add RetailerTransferProposal struct with productId, proposer, target, proposedPrice, retailerConfirmed, wholesalerConfirmed, executed fields
  - Add retailerTransferProposals mapping (uint => RetailerTransferProposal)
  - Add escrowedPayments mapping (uint => uint) to track held payments
  - Add retailer address field to Product struct
  - Add retailerRated boolean field to Product struct
  - Add new events: RetailerPurchaseProposed, RetailerPurchaseConfirmed, RetailerProposalRejected, RetailerProposalCancelled, ProductListedForSale, ConsumerPurchase
  - _Requirements: 1.2, 5.1, 5.2, 6.1, 6.2_

- [x] 2. Implement retailer purchase proposal functions in SupplyChain.sol
  - [x] 2.1 Write proposeRetailerPurchase function
    - Add payable modifier and productExists modifier
    - Validate caller has Retailer role via roleManager
    - Validate product is in state ReceivedByWholesaler (2) or Processed (3)
    - Validate msg.value equals product.pricePerUnit
    - Check no active proposal exists for this product
    - Create RetailerTransferProposal with retailerConfirmed = true
    - Store msg.value in escrowedPayments[_id]
    - Emit RetailerPurchaseProposed event
    - _Requirements: 1.2, 8.1_
  - [x] 2.2 Write cancelRetailerProposal function
    - Validate caller is the proposer
    - Validate proposal exists and not executed
    - Validate wholesaler has not confirmed
    - Refund escrowed payment to proposer
    - Delete proposal from mapping
    - Clear escrowedPayments[_id]
    - Emit RetailerProposalCancelled event
    - _Requirements: 8.5_

- [x] 3. Implement wholesaler confirmation functions in SupplyChain.sol
  - [x] 3.1 Write wholesalerConfirmRetailerPurchase function
    - Validate proposal exists and not executed
    - Validate caller is the target wholesaler (current owner)
    - Set wholesalerConfirmed = true
    - Transfer escrowed payment to wholesaler using call{value}
    - Transfer product ownership to retailer (proposer)
    - Set product.retailer = proposer address
    - Update product state to ShippedToRetailer (4)
    - Update lastUpdateTimestamp
    - Mark proposal as executed
    - Emit RetailerPurchaseConfirmed and OwnershipTransferred events
    - _Requirements: 1.5, 8.3_
  - [x] 3.2 Write wholesalerRejectRetailerPurchase function
    - Validate proposal exists and not executed
    - Validate caller is the target wholesaler
    - Refund escrowed payment to retailer (proposer)
    - Delete proposal from mapping
    - Clear escrowedPayments[_id]
    - Emit RetailerProposalRejected event
    - _Requirements: 8.4_

- [x] 4. Implement retailer listing and state management functions
  - [x] 4.1 Write retailerListForSale function
    - Add onlyOwner and productExists modifiers
    - Validate product state is ReceivedByRetailer (5)
    - Accept markup percentage parameter
    - Validate markup is positive
    - Calculate new price: oldPrice + (oldPrice * markup / 100)
    - Update product.pricePerUnit
    - Update product state to ForSale (6)
    - Update lastUpdateTimestamp
    - Emit ProductListedForSale event
    - _Requirements: 3.2, 3.4_
  - [x] 4.2 Update updateProductState function for retailer receipt
    - Add state transition validation: ShippedToRetailer (4) → ReceivedByRetailer (5)
    - Add require statement: "Retailer can only receive products shipped to them"
    - Ensure only owner (retailer) can perform this transition
    - _Requirements: 3.1_

- [x] 5. Implement consumer purchase and rating functions
  - [x] 5.1 Write consumerBuyFromRetailer function
    - Add payable and productExists modifiers
    - Validate caller has Consumer role via roleManager
    - Validate product state is ForSale (6)
    - Validate msg.value equals product.pricePerUnit
    - Transfer payment to current owner (retailer) using call{value}
    - Require payment transfer success
    - Transfer ownership to consumer (msg.sender)
    - Update product state to SoldToConsumer (7)
    - Update lastUpdateTimestamp
    - Emit ConsumerPurchase and OwnershipTransferred events
    - _Requirements: 2.3, 2.4_
  - [x] 5.2 Write consumerRateRetailer function
    - Add productExists modifier
    - Validate caller is current owner (consumer)
    - Validate product state is SoldToConsumer (7)
    - Validate product.retailer is not zero address
    - Validate score is between 1 and 5
    - Check !product.retailerRated flag
    - Set product.retailerRated = true
    - Call roleManager.addRating(product.retailer, score)
    - Emit ProductRated event
    - _Requirements: 4.2, 4.3, 4.4_

- [x] 6. Update frontend config.js with new constants
  - Update STATE_MAPPING to clarify state 4 as "Shipped To Retailer" and state 7 as "Sold To Consumer"
  - Add RETAILER_FOR_SALE_STATES constant = [6]
  - Export new constants for use in components
  - _Requirements: 7.1, 7.2_

- [x] 7. Enhance RetailerView.js component with proposal and listing features
  - [x] 7.1 Add state management for proposals and actions
    - Add pendingProposals state array
    - Add proposalLoading state boolean
    - Add fetchMyProposals function to query retailerTransferProposals
    - Filter proposals where proposer === connectedWallet
    - _Requirements: 7.1, 7.3_
  - [x] 7.2 Implement handleProposePurchase function
    - Validate product price and user balance
    - Call contract.proposeRetailerPurchase with value: pricePerUnit
    - Show loading message during transaction
    - Wait for transaction confirmation
    - Display success message
    - Refresh products and proposals
    - Handle errors with user-friendly messages
    - _Requirements: 1.1, 1.2, 8.1_
  - [x] 7.3 Implement handleCancelProposal function
    - Call contract.cancelRetailerProposal(productId)
    - Show loading and confirmation messages
    - Refresh proposals after cancellation
    - Display refund confirmation
    - _Requirements: 8.5_
  - [x] 7.4 Implement handleConfirmReceipt function
    - Call contract.updateProductState(productId, 5)
    - Transition from ShippedToRetailer (4) to ReceivedByRetailer (5)
    - Show success message
    - Refresh products
    - _Requirements: 3.1_
  - [x] 7.5 Implement handleListForSale function
    - Accept productId and markupPercentage parameters
    - Validate markup is positive number
    - Call contract.retailerListForSale(productId, markup)
    - Show price calculation preview
    - Display success message with new price
    - Refresh products
    - _Requirements: 3.2, 3.4_
  - [x] 7.6 Update JSX to display three sections
    - Wholesaler Marketplace: products in states 2 or 3, not owned, with "Propose Purchase" button
    - Pending Proposals: my proposals with product info, status, and "Cancel" button
    - My Inventory: owned products with state-specific actions (confirm receipt, list for sale, rate wholesaler)
    - _Requirements: 7.1, 7.3_

- [x] 8. Enhance WholesalerView.js with retailer proposal management
  - [x] 8.1 Add fetchRetailerProposals function
    - Loop through owned products in states 2 or 3
    - Query retailerTransferProposals[productId] for each
    - Filter proposals where target === connectedWallet and !executed
    - Store in pendingRetailerProposals state
    - _Requirements: 1.4_
  - [x] 8.2 Implement handleAcceptRetailerPurchase function
    - Call contract.wholesalerConfirmRetailerPurchase(productId)
    - Show loading message
    - Wait for confirmation
    - Display success message with payment received
    - Refresh products and proposals
    - _Requirements: 1.5, 8.3_
  - [x] 8.3 Implement handleRejectRetailerPurchase function
    - Call contract.wholesalerRejectRetailerPurchase(productId)
    - Show confirmation dialog
    - Display refund message
    - Refresh proposals
    - _Requirements: 8.4_
  - [x] 8.4 Add "Incoming Retailer Proposals" section to JSX
    - Display table with columns: Product ID, Name, Retailer Address, Proposed Price, Actions
    - Show "Accept" and "Reject" buttons for each proposal
    - Display loading state while fetching
    - Show empty state if no proposals
    - _Requirements: 1.4, 7.4_

- [x] 9. Create ConsumerView.js component
  - [x] 9.1 Create component structure and imports
    - Import React, useState, ethers, Dashboard, ProductHistoryModal
    - Import SUPPLY_CHAIN_ABI, SUPPLY_CHAIN_ADDRESS from config
    - Import RETAILER_FOR_SALE_STATES constant
    - Set up state: actionLoading, actionMessage, historyModalOpen, selectedProduct
    - _Requirements: 2.1, 7.2_
  - [x] 9.2 Implement handleBuyProduct function
    - Accept productId and price parameters
    - Format price for display message
    - Call contract.consumerBuyFromRetailer with value: price
    - Show transaction progress messages
    - Wait for confirmation
    - Display success message
    - Refresh products via fetchProducts
    - Handle errors: user rejection, incorrect payment, role validation
    - _Requirements: 2.3, 2.4_
  - [x] 9.3 Implement handleRateRetailer function
    - Accept productId and score (1-5) parameters
    - Validate score range
    - Call contract.consumerRateRetailer(productId, score)
    - Show loading message
    - Display success message
    - Refresh products to update UI
    - Handle duplicate rating error
    - _Requirements: 4.1, 4.2, 4.3_
  - [x] 9.4 Implement product filtering logic
    - Filter marketplaceProducts: state === 6 (ForSale) AND owner !== connectedWallet
    - Filter myPurchases: owner === connectedWallet (any state, typically 7)
    - _Requirements: 2.1, 2.5_
  - [x] 9.5 Build JSX with two main sections
    - Retailer Marketplace section: Display marketplaceProducts in Dashboard with "Buy Now" actions
    - My Purchases section: Display myPurchases with full supply chain history and rating interface
    - Add ProductHistoryModal for viewing product journey
    - Include logout button and action message display
    - _Requirements: 2.1, 2.2, 2.5, 7.2, 7.5_

- [x] 10. Update Dashboard.js ProductActions component for new roles
  - [x] 10.1 Add Retailer action logic
    - For marketplace products (not owner, states 2 or 3): Show "Propose Purchase (Pay Now)" button calling onAction with price
    - For owned products in state 4: Show "Confirm Receipt" button
    - For owned products in state 5: Show markup input and "List for Sale" button calling onSetPrice
    - For owned products in states 6 or 7: Show rating interface if wholesaler not rated
    - _Requirements: 7.3_
  - [x] 10.2 Add Consumer action logic
    - For marketplace products (not owner, state 6): Show "Buy Now" button calling onAction with price
    - For owned products (state 7): Show retailer rating interface if not rated
    - Display "No action" for other states
    - _Requirements: 2.2, 4.1_
  - [x] 10.3 Update product display to show retailer rating
    - Add RatingBadge for product.retailer if address exists
    - Display alongside farmer and wholesaler ratings
    - Show label "Retailer rating"
    - _Requirements: 2.2, 4.5_

- [x] 11. Update App.js to include ConsumerView routing
  - Import ConsumerView component
  - Add case 'Consumer' in renderContent switch statement
  - Pass props: products, loading, connectedWallet, fetchProducts, onLogout
  - Ensure ConsumerView receives all necessary data
  - _Requirements: 2.1_

- [x] 12. Update product fetching in App.js to include new fields
  - Add retailer field mapping: retailer: item.retailer
  - Add retailerRated field mapping: retailerRated: item.retailerRated
  - Ensure fetchProducts callback includes new Product struct fields
  - _Requirements: 6.3, 6.5_

- [x] 13. Deploy and test updated smart contracts
  - Compile contracts with hardhat compile
  - Update deployment script if needed for new contract structure
  - Deploy to local hardhat network for testing
  - Deploy to Sepolia testnet
  - Verify contracts on Etherscan
  - Update frontend config.js with new contract addresses
  - Copy updated ABI files to frontend/src/abi/
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 14. End-to-end integration testing
  - Test complete flow: Farmer → Wholesaler → Retailer → Consumer
  - Verify retailer can propose purchase with payment escrow
  - Verify wholesaler can accept/reject retailer proposals
  - Verify payment transfers correctly on acceptance
  - Verify payment refunds correctly on rejection
  - Verify retailer can confirm receipt and list for sale
  - Verify consumer can browse and purchase from retailer marketplace
  - Verify consumer can rate retailer after purchase
  - Verify all ratings display correctly in RatingBadge components
  - Verify product history shows complete supply chain
  - Test error cases: insufficient payment, wrong role, duplicate ratings
  - _Requirements: All requirements_
